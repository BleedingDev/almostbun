<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Core Concepts — almostnode docs</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<div class="topbar">
  <label class="menu-toggle" for="sidebar-check">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </label>
  <a href="../" class="topbar-logo"><span>almostnode</span></a>
  <span class="topbar-sep">/</span>
  <span class="topbar-section">Docs</span>
  <ul class="topbar-links">
    <li><a href="https://github.com/Macaly/almostnode">GitHub</a></li>
    <li><a href="https://www.npmjs.com/package/almostnode">npm</a></li>
  </ul>
</div>

<input type="checkbox" id="sidebar-check">
<div class="layout">
  <nav class="sidebar">
    <div class="sidebar-group">
      <div class="sidebar-label">Guide</div>
      <a href="./">Getting Started</a>
      <a href="./core-concepts.html" class="active">Core Concepts</a>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-label">Frameworks</div>
      <a href="./nextjs-guide.html">Next.js</a>
      <a href="./vite-guide.html">Vite</a>
    </div>
    <div class="sidebar-group">
      <div class="sidebar-label">Reference</div>
      <a href="./api-reference.html">API Reference</a>
    </div>
  </nav>

  <main class="content">
    <h1>Core Concepts</h1>
    <p class="lead">almostnode is built on four core primitives that work together to simulate a Node.js environment in the browser.</p>

    <h2>Architecture Overview</h2>
    <p>Every almostnode app uses these components:</p>
    <pre><code><span class="cm">┌─────────────────────────────────────────┐</span>
<span class="cm">│            Your Application              │</span>
<span class="cm">├─────────────────────────────────────────┤</span>
<span class="cm">│  Framework Dev Servers (Next.js / Vite)  │</span>
<span class="cm">├──────────┬──────────┬───────────────────┤</span>
<span class="cm">│  Runtime │   npm    │   ServerBridge    │</span>
<span class="cm">├──────────┴──────────┴───────────────────┤</span>
<span class="cm">│           VirtualFS (in-memory)          │</span>
<span class="cm">└─────────────────────────────────────────┘</span></code></pre>

    <ul>
      <li><strong>VirtualFS</strong> — an in-memory filesystem that stores all files</li>
      <li><strong>Runtime</strong> — executes JavaScript/TypeScript with Node.js module resolution</li>
      <li><strong>PackageManager</strong> — installs npm packages into the virtual filesystem</li>
      <li><strong>ServerBridge</strong> — connects virtual servers to real browser URLs via a service worker</li>
    </ul>

    <h2>VirtualFS</h2>
    <p>VirtualFS provides a POSIX-compatible filesystem API that stores files in memory. It supports directories, binary files, file watching, and all the common <code>fs</code> operations you'd expect from Node.js.</p>

    <pre><code><span class="kw">import</span> <span class="op">{</span> VirtualFS <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> vfs <span class="op">=</span> <span class="kw">new</span> <span class="fn">VirtualFS</span><span class="op">();</span>

<span class="cm">// Create directories</span>
vfs<span class="op">.</span><span class="fn">mkdirSync</span><span class="op">(</span><span class="str">'/src'</span><span class="op">,</span> <span class="op">{</span> recursive<span class="op">:</span> <span class="kw">true</span> <span class="op">});</span>

<span class="cm">// Write files</span>
vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/src/index.js'</span><span class="op">,</span> <span class="str">'console.log("hello")'</span><span class="op">);</span>

<span class="cm">// Read files</span>
<span class="kw">const</span> content <span class="op">=</span> vfs<span class="op">.</span><span class="fn">readFileSync</span><span class="op">(</span><span class="str">'/src/index.js'</span><span class="op">,</span> <span class="str">'utf8'</span><span class="op">);</span>

<span class="cm">// List directory contents</span>
<span class="kw">const</span> files <span class="op">=</span> vfs<span class="op">.</span><span class="fn">readdirSync</span><span class="op">(</span><span class="str">'/src'</span><span class="op">);</span> <span class="cm">// ['index.js']</span>

<span class="cm">// Watch for changes</span>
vfs<span class="op">.</span><span class="fn">watch</span><span class="op">(</span><span class="str">'/src'</span><span class="op">,</span> <span class="op">(</span>event<span class="op">,</span> filename<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span>
  console<span class="op">.</span><span class="fn">log</span><span class="op">(</span>event<span class="op">,</span> filename<span class="op">);</span>
<span class="op">});</span></code></pre>

    <h3>Key Features</h3>
    <ul>
      <li><code>writeFileSync</code> automatically creates parent directories</li>
      <li><code>watch()</code> emits events when files change — used by HMR in framework dev servers</li>
      <li>Supports both string (utf8) and binary (<code>Uint8Array</code>) file content</li>
      <li><code>toSnapshot()</code> and <code>fromSnapshot()</code> allow serializing the entire filesystem</li>
    </ul>

    <h2>Runtime</h2>
    <p>The Runtime executes JavaScript and TypeScript code with CommonJS module resolution. It shims 40+ Node.js built-in modules so code written for Node.js can run in the browser.</p>

    <pre><code><span class="kw">import</span> <span class="op">{</span> VirtualFS<span class="op">,</span> Runtime <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> vfs <span class="op">=</span> <span class="kw">new</span> <span class="fn">VirtualFS</span><span class="op">();</span>
<span class="kw">const</span> runtime <span class="op">=</span> <span class="kw">new</span> <span class="fn">Runtime</span><span class="op">(</span>vfs<span class="op">);</span>

<span class="cm">// Execute code directly</span>
runtime<span class="op">.</span><span class="fn">execute</span><span class="op">(</span><span class="str">`
  const path = require('path');
  console.log(path.join('/foo', 'bar', 'baz.js'));
`</span><span class="op">);</span>

<span class="cm">// Or run a file from the VFS</span>
vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/app.js'</span><span class="op">,</span> <span class="str">'module.exports = { version: 1 }'</span><span class="op">);</span>
<span class="kw">const</span> result <span class="op">=</span> runtime<span class="op">.</span><span class="fn">runFile</span><span class="op">(</span><span class="str">'/app.js'</span><span class="op">);</span>
console<span class="op">.</span><span class="fn">log</span><span class="op">(</span>result<span class="op">.</span>exports<span class="op">);</span> <span class="cm">// { version: 1 }</span></code></pre>

    <h3>Shimmed Modules</h3>
    <p>The runtime includes shims for these Node.js built-in modules:</p>
    <p><code>assert</code>, <code>buffer</code>, <code>child_process</code>, <code>console</code>, <code>crypto</code>, <code>dns</code>, <code>events</code>, <code>fs</code>, <code>http</code>, <code>https</code>, <code>module</code>, <code>net</code>, <code>os</code>, <code>path</code>, <code>process</code>, <code>querystring</code>, <code>readline</code>, <code>stream</code>, <code>string_decoder</code>, <code>timers</code>, <code>tls</code>, <code>tty</code>, <code>url</code>, <code>util</code>, <code>vm</code>, <code>worker_threads</code>, <code>zlib</code>, and more.</p>

    <h3>Module Resolution</h3>
    <p>The runtime follows Node.js module resolution rules:</p>
    <ol>
      <li>Built-in modules (<code>require('fs')</code>, <code>require('node:path')</code>)</li>
      <li>Relative paths (<code>require('./utils')</code>) — resolves <code>.js</code>, <code>.ts</code>, <code>.json</code>, <code>/index.js</code></li>
      <li>npm packages (<code>require('express')</code>) — looks in <code>node_modules/</code></li>
    </ol>

    <h2>PackageManager</h2>
    <p>The PackageManager installs real npm packages into the virtual filesystem. It fetches tarballs from the npm registry, resolves the full dependency tree, and extracts files — all in the browser.</p>

    <pre><code><span class="kw">import</span> <span class="op">{</span> VirtualFS<span class="op">,</span> PackageManager <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> vfs <span class="op">=</span> <span class="kw">new</span> <span class="fn">VirtualFS</span><span class="op">();</span>
<span class="kw">const</span> npm <span class="op">=</span> <span class="kw">new</span> <span class="fn">PackageManager</span><span class="op">(</span>vfs<span class="op">);</span>

<span class="cm">// Install a single package</span>
<span class="kw">await</span> npm<span class="op">.</span><span class="fn">install</span><span class="op">(</span><span class="str">'lodash'</span><span class="op">);</span>

<span class="cm">// Install a specific version</span>
<span class="kw">await</span> npm<span class="op">.</span><span class="fn">install</span><span class="op">(</span><span class="str">'react@18.2.0'</span><span class="op">);</span>

<span class="cm">// Install all deps from package.json</span>
vfs<span class="op">.</span><span class="fn">writeFileSync</span><span class="op">(</span><span class="str">'/package.json'</span><span class="op">,</span> <span class="fn">JSON</span><span class="op">.</span><span class="fn">stringify</span><span class="op">({</span>
  dependencies<span class="op">:</span> <span class="op">{</span> express<span class="op">:</span> <span class="str">'^4.18.0'</span> <span class="op">}</span>
<span class="op">}));</span>
<span class="kw">await</span> npm<span class="op">.</span><span class="fn">installFromPackageJson</span><span class="op">();</span>

<span class="cm">// List installed packages</span>
console<span class="op">.</span><span class="fn">log</span><span class="op">(</span>npm<span class="op">.</span><span class="fn">list</span><span class="op">());</span> <span class="cm">// { express: '4.18.2', ... }</span></code></pre>

    <h2>ServerBridge</h2>
    <p>The ServerBridge connects virtual HTTP servers to real browser URLs using a service worker. When a request hits <code>/__virtual__/{port}/path</code>, the service worker intercepts it and forwards it to the registered virtual server.</p>

    <pre><code><span class="kw">import</span> <span class="op">{</span> <span class="fn">getServerBridge</span> <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> bridge <span class="op">=</span> <span class="fn">getServerBridge</span><span class="op">();</span>

<span class="cm">// Initialize the service worker</span>
<span class="kw">await</span> bridge<span class="op">.</span><span class="fn">initServiceWorker</span><span class="op">();</span>

<span class="cm">// Register a virtual server on port 3000</span>
bridge<span class="op">.</span><span class="fn">registerServer</span><span class="op">(</span>myServer<span class="op">,</span> <span class="num">3000</span><span class="op">);</span>

<span class="cm">// Now accessible at /__virtual__/3000/ in an iframe</span>
<span class="kw">const</span> url <span class="op">=</span> bridge<span class="op">.</span><span class="fn">getServerUrl</span><span class="op">(</span><span class="num">3000</span><span class="op">);</span>
iframe<span class="op">.</span>src <span class="op">=</span> url<span class="op">;</span></code></pre>

    <h3>How It Works</h3>
    <ol>
      <li><code>initServiceWorker()</code> registers a service worker that intercepts fetch requests</li>
      <li><code>registerServer()</code> maps a port number to a virtual server object</li>
      <li>When the browser requests <code>/__virtual__/3000/path</code>, the service worker sends it to the registered server</li>
      <li>The server processes the request and returns a response — all without any real network traffic</li>
    </ol>

    <h2>Putting It All Together</h2>
    <p>The <code>createContainer()</code> helper creates all four components for you:</p>
    <pre><code><span class="kw">import</span> <span class="op">{</span> <span class="fn">createContainer</span> <span class="op">}</span> <span class="kw">from</span> <span class="str">'almostnode'</span><span class="op">;</span>

<span class="kw">const</span> <span class="op">{</span>
  vfs<span class="op">,</span>          <span class="cm">// VirtualFS instance</span>
  runtime<span class="op">,</span>      <span class="cm">// Runtime instance</span>
  npm<span class="op">,</span>          <span class="cm">// PackageManager instance</span>
  serverBridge<span class="op">,</span> <span class="cm">// ServerBridge instance</span>
  execute<span class="op">,</span>      <span class="cm">// Shorthand for runtime.execute()</span>
  runFile<span class="op">,</span>      <span class="cm">// Shorthand for runtime.runFile()</span>
<span class="op">}</span> <span class="op">=</span> <span class="fn">createContainer</span><span class="op">();</span></code></pre>

    <div class="page-nav">
      <a href="./">
        <div class="label">Previous</div>
        <div class="title">Getting Started</div>
      </a>
      <a href="./nextjs-guide.html" class="next">
        <div class="label">Next</div>
        <div class="title">Next.js Guide</div>
      </a>
    </div>
  </main>
</div>

</body>
</html>
